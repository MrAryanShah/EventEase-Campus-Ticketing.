<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manual Check-In | EventEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <style>
        body { background-color: #0a0612; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <div class="max-w-md w-full glass p-8 rounded-3xl shadow-2xl space-y-6">
        <div class="text-center">
            <h2 class="text-2xl font-black text-white">Manual <span class="text-fuchsia-500">Check-In</span></h2>
            <p class="text-gray-400 text-sm mt-1">Enter Ticket ID if camera is unavailable</p>
        </div>

        <div class="space-y-4">
            <input id="qrInput" type="text" placeholder="Paste EventID_UserID here..." 
                   class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-fuchsia-500 transition">
            
            <button onclick="checkIn()" 
                    class="w-full bg-gradient-to-r from-fuchsia-600 to-purple-600 hover:from-fuchsia-500 hover:to-purple-500 text-white font-bold py-3 rounded-xl transition transform active:scale-95">
                Confirm Entry
            </button>
        </div>

        <p id="status" class="text-center font-semibold min-h-[1.5rem]"></p>
        
        <div class="pt-4 border-t border-white/5 text-center">
            <a href="scanner.html" class="text-xs text-fuchsia-400 hover:text-fuchsia-300 transition uppercase tracking-widest font-bold">
                <i class="fas fa-camera mr-2"></i> Switch to Camera
            </a>
        </div>
    </div>

<script>
firebase.initializeApp({
    apiKey: "AIzaSyDdPJJd5bDCPumIxFrxtj176S1Bozseyjk",
    authDomain: "eventease-202e2.firebaseapp.com",
    projectId: "eventease-202e2"
});

const db = firebase.firestore();

async function checkIn() {
    const status = document.getElementById("status");
    const qr = document.getElementById("qrInput").value.trim();
    
    if(!qr.includes("_")) {
        status.innerText = "❌ Invalid Format (Missing _)";
        status.className = "text-center text-red-400";
        return;
    }

    const [eventId, userId] = qr.split("_");

    try {
        const docRef = db.collection("events").doc(eventId).collection("registrations").doc(userId);
        const doc = await docRef.get();

        if (!doc.exists) {
            status.innerText = "❌ User Not Found";
            status.className = "text-center text-red-400";
            return;
        }

        if (doc.data().checkedIn === true) {
            status.innerText = "⚠️ Already Checked In";
            status.className = "text-center text-orange-400";
        } else {
            await docRef.update({ 
                checkedIn: true,
                checkInTime: firebase.firestore.FieldValue.serverTimestamp()
            });
            status.innerText = "✅ Entry Allowed!";
            status.className = "text-center text-emerald-400";
        }
    } catch (err) {
        status.innerText = "❌ Database Error";
        status.className = "text-center text-red-400";
    }
}
</script>
</body>
</html>