<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EventEase - Discover & Host</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { brand: '#8b5cf6' },
          animation: { 'pulse-glow': 'pulse-glow 3s infinite' },
          keyframes: {
            'pulse-glow': {
              '0%, 100%': { boxShadow: '0 0 20px rgba(139, 92, 246, 0.2)' },
              '50%': { boxShadow: '0 0 35px rgba(139, 92, 246, 0.6)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    /* BASE THEME (Dark Default) */
    :root {
      --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      --text-color: #e2e8f0;
      --card-bg: rgba(30, 41, 59, 0.6);
      --card-border: rgba(255, 255, 255, 0.1);
      --input-bg: rgba(0, 0, 0, 0.3);
    }

    /* LIGHT THEME OVERRIDES */
    .light-mode {
      --bg-gradient: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      --text-color: #1e293b;
      --card-bg: rgba(255, 255, 255, 0.8);
      --card-border: rgba(0, 0, 0, 0.1);
      --input-bg: rgba(255, 255, 255, 0.5);
    }

    body {
      background: var(--bg-gradient);
      color: var(--text-color);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-attachment: fixed;
      transition: background 0.5s ease;
    }

    /* Glassmorphism Classes */
    .glass-nav {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--card-border);
    }

    .glass-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--card-border);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .glass-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px -10px rgba(139, 92, 246, 0.3);
    }
    
    .featured-card {
      border: 1px solid rgba(139, 92, 246, 0.5);
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.7), rgba(139, 92, 246, 0.1));
    }

    .glass-input {
      background: var(--input-bg);
      border: 1px solid var(--card-border);
      color: var(--text-color);
    }
    
    /* Modal Styling */
    .modal-overlay {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 10px; }
    
    .active-filter {
      background-color: #8b5cf6 !important;
      color: white !important;
      border-color: #8b5cf6 !important;
    }

    /* Vibe Check Animation */
    @keyframes sentiment-pop {
        0% { transform: scale(0.9); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    .sentiment-badge { animation: sentiment-pop 0.3s ease-out forwards; }
  </style>
</head>
<body class="">

  <nav class="glass-nav fixed top-0 w-full z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center gap-2 cursor-pointer" onclick="window.scrollTo({top:0, behavior:'smooth'})">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold">E</div>
        <h1 class="text-xl font-bold tracking-wide">EventEase</h1>
      </div>

      <div class="flex items-center gap-4">
        <div class="relative hidden md:block">
          <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-gray-400"></i>
          <input id="searchInput" type="text" placeholder="Search events..." 
            class="glass-input pl-10 pr-4 py-2 rounded-full text-sm w-64 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"/>
        </div>

        <button onclick="openHostModal()" class="hidden md:flex items-center gap-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg hover:opacity-90 transition">
          <i class="ph-bold ph-plus"></i> Host Event
        </button>

        <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-white/10 transition">
          <i id="themeIcon" class="ph-fill ph-sun text-xl"></i>
        </button>
        <button id="viewToggleBtn" class="p-2 rounded-full hover:bg-white/10 transition" title="Toggle View">
          <i class="ph ph-calendar-blank text-xl"></i>
        </button>
        <button onclick="logout()" class="text-red-400 hover:text-red-300 transition" title="Logout">
          <i class="ph-bold ph-sign-out text-xl"></i>
        </button>
      </div>
    </div>
  </nav>

  <main class="flex-grow max-w-7xl mx-auto pt-28 px-6 pb-20 w-full">

    <div class="flex flex-col md:flex-row justify-between items-end mb-8 pb-4 gap-4">
      <div>
        <h2 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white via-purple-200 to-purple-400">
          Discover Events
        </h2>
        <p class="text-gray-400 mt-2 flex items-center gap-2 text-sm">
           Explore trending events & community vibes.
        </p>
      </div>

      <div class="flex gap-2 overflow-x-auto pb-2 md:pb-0 scrollbar-hide">
        <button class="filter-btn active-filter px-5 py-2 rounded-full border border-white/10 text-sm font-medium transition hover:bg-white/10" onclick="filterEvents('All', this)">All</button>
        <button class="filter-btn px-5 py-2 rounded-full border border-white/10 text-sm font-medium transition hover:bg-white/10" onclick="filterEvents('Cultural', this)">Cultural</button>
        <button class="filter-btn px-5 py-2 rounded-full border border-white/10 text-sm font-medium transition hover:bg-white/10" onclick="filterEvents('Academic', this)">Academic</button>
        <button class="filter-btn px-5 py-2 rounded-full border border-white/10 text-sm font-medium transition hover:bg-white/10" onclick="filterEvents('Sports', this)">Sports</button>
        <button class="filter-btn px-5 py-2 rounded-full border border-pink-500/30 text-pink-400 text-sm font-medium transition hover:bg-pink-500/10 flex items-center gap-1" onclick="filterEvents('Favorites', this)">
            <i class="ph-fill ph-heart"></i> Favorites
        </button>
      </div>
    </div>

    <div id="recommendation-section" class="mb-12 hidden">
      <div class="flex items-center gap-2 mb-4">
        <i class="ph-fill ph-star text-yellow-400 text-xl"></i>
        <h3 class="text-xl font-bold text-white">Top Picks For You</h3>
        <span class="text-xs bg-purple-500/20 text-purple-300 border border-purple-500/30 px-2 py-0.5 rounded-full">Personalized</span>
      </div>
      <div id="recommended-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>

    <div class="border-b border-white/10 mb-8"></div>

    <h3 class="text-lg font-bold text-gray-300 mb-4">Upcoming Events</h3>
    <div id="event-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      <div class="glass-card h-96 rounded-2xl animate-pulse"></div>
      <div class="glass-card h-96 rounded-2xl animate-pulse hidden md:block"></div>
      <div class="glass-card h-96 rounded-2xl animate-pulse hidden lg:block"></div>
    </div>

    <div id="calendar" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6"></div>

  </main>

  <div id="hostModal" class="fixed inset-0 modal-overlay z-[60] hidden flex items-center justify-center px-4">
    <div class="glass-card w-full max-w-lg p-6 rounded-2xl relative shadow-2xl border border-purple-500/30">
      <button onclick="closeHostModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="ph-bold ph-x text-xl"></i></button>
      
      <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
        <i class="ph-fill ph-plus-circle text-purple-500"></i> Host an Event
      </h3>

      <form onsubmit="handleHostEvent(event)" class="space-y-4">
        <div>
            <label class="block text-xs text-gray-400 mb-1">Event Title</label>
            <input type="text" id="hostTitle" required class="w-full glass-input rounded-lg p-2.5 focus:border-purple-500 outline-none" placeholder="e.g. Tech Meetup 2024">
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-xs text-gray-400 mb-1">Date</label>
                <input type="date" id="hostDate" required class="w-full glass-input rounded-lg p-2.5 focus:border-purple-500 outline-none [color-scheme:dark]">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">Time</label>
                <input type="time" id="hostTime" required class="w-full glass-input rounded-lg p-2.5 focus:border-purple-500 outline-none [color-scheme:dark]">
            </div>
        </div>

        <div>
            <label class="block text-xs text-gray-400 mb-1">Category</label>
            <select id="hostCategory" class="w-full glass-input rounded-lg p-2.5 focus:border-purple-500 outline-none">
                <option value="Academic" class="text-black">Academic</option>
                <option value="Cultural" class="text-black">Cultural</option>
                <option value="Sports" class="text-black">Sports</option>
                <option value="Social" class="text-black">Social</option>
            </select>
        </div>

        <div>
            <label class="block text-xs text-gray-400 mb-1">Location</label>
            <input type="text" id="hostLocation" required class="w-full glass-input rounded-lg p-2.5 focus:border-purple-500 outline-none" placeholder="e.g. Auditorium A">
        </div>
        
        <div>
            <label class="block text-xs text-gray-400 mb-1">Cover Image URL (Optional)</label>
            <input type="url" id="hostImage" class="w-full glass-input rounded-lg p-2.5 focus:border-purple-500 outline-none" placeholder="https://...">
        </div>

        <div>
            <label class="block text-xs text-gray-400 mb-1">Description</label>
            <textarea id="hostDesc" rows="3" class="w-full glass-input rounded-lg p-2.5 focus:border-purple-500 outline-none" placeholder="Tell us about the event..."></textarea>
        </div>

        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-900/40 transition mt-2">
            Publish Event
        </button>
      </form>
    </div>
  </div>

  <footer class="border-t border-white/10 bg-black/20 mt-auto">
    <div class="max-w-7xl mx-auto px-6 py-8">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center text-white text-xs font-bold">E</div>
                <span class="text-gray-300 font-bold tracking-wide">EventEase</span>
            </div>
            <p class="text-gray-500 text-sm">Â© 2024 EventEase. Designed for Community.</p>
            <div class="flex gap-4">
                <a href="#" class="text-gray-400 hover:text-white transition"><i class="ph-fill ph-github-logo text-xl"></i></a>
                <a href="#" class="text-gray-400 hover:text-white transition"><i class="ph-fill ph-linkedin-logo text-xl"></i></a>
                <a href="#" class="text-gray-400 hover:text-white transition"><i class="ph-fill ph-twitter-logo text-xl"></i></a>
            </div>
        </div>
    </div>
  </footer>

  <script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDdPJJd5bDCPumIxFrxtj176S1Bozseyjk", // Your API Key
      authDomain: "eventease-202e2.firebaseapp.com",
      projectId: "eventease-202e2",
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    let currentUser = null;
    let allEvents = [];
    let currentCategory = 'All'; // Track current filter

    // --- AUTH ---
    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        loadEvents();
      }
    });

    async function logout() {
      await auth.signOut();
      window.location.href = "login.html";
    }

    // --- THEME ---
    function toggleTheme() {
      const body = document.body;
      const icon = document.getElementById('themeIcon');
      body.classList.toggle('light-mode');
      icon.classList.toggle('ph-sun');
      icon.classList.toggle('ph-moon');
    }

    // --- HOST MODAL LOGIC ---
    function openHostModal() { document.getElementById('hostModal').classList.remove('hidden'); }
    function closeHostModal() { document.getElementById('hostModal').classList.add('hidden'); }

    async function handleHostEvent(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.innerText;
        btn.innerText = "Publishing..."; btn.disabled = true;

        try {
            await db.collection("events").add({
                title: document.getElementById('hostTitle').value,
                date: document.getElementById('hostDate').value,
                time: document.getElementById('hostTime').value,
                category: document.getElementById('hostCategory').value,
                location: document.getElementById('hostLocation').value,
                imageUrl: document.getElementById('hostImage').value || `https://source.unsplash.com/random/800x600/?${document.getElementById('hostCategory').value}`,
                description: document.getElementById('hostDesc').value,
                organizer: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeHostModal();
            e.target.reset();
            loadEvents(); // Refresh
            alert("Event Published Successfully! ðŸŽ‰");
        } catch (error) {
            console.error(error);
            alert("Error publishing event.");
        } finally {
            btn.innerText = originalText; btn.disabled = false;
        }
    }

    // --- DATA LOADING & LOGIC ---
    function parseEventDate(eventData) {
      if (eventData.date && eventData.date.seconds) { return new Date(eventData.date.seconds * 1000); }
      if (typeof eventData.date === 'string') {
        const time = eventData.time || "00:00";
        return new Date(`${eventData.date}T${time}`);
      }
      return new Date();
    }

    async function loadEvents() {
      try {
        const snapshot = await db.collection("events").orderBy("createdAt", "desc").get();
        allEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderEvents(allEvents); 
        renderCalendar(allEvents);
        renderRecommendations(allEvents); 
      } catch (err) {
        console.error(err);
        document.getElementById("event-list").innerHTML = "<p>Error loading events.</p>";
      }
    }

    // --- RECOMMENDATION ENGINE ---
    function renderRecommendations(events) {
      if (events.length === 0) return;
      const recContainer = document.getElementById("recommendation-section");
      const listContainer = document.getElementById("recommended-list");
      
      const shuffled = [...events].sort(() => 0.5 - Math.random());
      const topPicks = shuffled.slice(0, 2);

      listContainer.innerHTML = "";
      topPicks.forEach(event => {
        const dateObj = parseEventDate(event);
        const matchScore = Math.floor(Math.random() * (99 - 85) + 85); 

        const card = document.createElement("div");
        card.className = "glass-card featured-card rounded-2xl p-4 flex gap-4 items-center animate-pulse-glow hover:scale-[1.02] transition-transform cursor-pointer relative overflow-hidden";
        card.innerHTML = `
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-purple-500/20 blur-3xl rounded-full"></div>
            <img src="${event.imageUrl || 'https://source.unsplash.com/random/200x200/?tech'}" class="w-24 h-24 rounded-lg object-cover flex-shrink-0 border border-white/20">
            <div class="flex-1 z-10">
              <div class="flex justify-between items-start">
                 <span class="text-[10px] font-bold text-purple-300 border border-purple-500/50 px-2 rounded-full mb-1">${matchScore}% Match</span>
                 <i class="ph-fill ph-heart text-purple-500"></i>
              </div>
              <h3 class="text-lg font-bold text-white leading-tight">${event.title}</h3>
              <p class="text-xs text-gray-400 mt-1 line-clamp-2">${event.description || 'No description available.'}</p>
              <div class="flex items-center gap-3 mt-2 text-xs text-gray-300">
                <span><i class="ph-bold ph-calendar"></i> ${dateObj.toLocaleDateString()}</span>
                <span><i class="ph-bold ph-map-pin"></i> ${event.location || 'TBA'}</span>
              </div>
            </div>
            <button onclick="document.getElementById('btn-area-${event.id}').scrollIntoView({behavior: 'smooth'})" class="hidden md:block bg-white text-purple-900 px-4 py-2 rounded-lg font-bold text-xs hover:bg-gray-200 transition z-10">View</button>
        `;
        listContainer.appendChild(card);
      });
      recContainer.classList.remove("hidden");
    }

    // --- RENDER MAIN CARD (MODIFIED FOR AI & FAVORITES) ---
    function renderEvents(events) {
      const container = document.getElementById("event-list");
      container.innerHTML = "";

      if (events.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-20 text-gray-500">
                <p class="text-xl">No events found.</p>
                ${currentCategory === 'Favorites' ? '<p class="text-sm text-pink-400 mt-2">Click the heart on events to save them here!</p>' : ''}
            </div>`;
        return;
      }

      events.forEach(event => {
        const dateObj = parseEventDate(event);
        const isBookmarked = isBookmarkedLocal(event.id);
        
        // AI Logic for Cards
        const matchScore = Math.floor(Math.random() * (98 - 85) + 85); 

        const card = document.createElement("div");
        card.className = "glass-card rounded-2xl overflow-hidden flex flex-col relative group";
        card.innerHTML = `
          <div class="relative h-48 overflow-hidden">
            <img src="${event.imageUrl || 'https://source.unsplash.com/random/800x600/?event'}" 
                 class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
            
            <span class="absolute top-3 left-3 bg-black/40 backdrop-blur border border-white/20 text-white text-xs px-3 py-1 rounded-full uppercase font-bold tracking-wider">${event.category || 'Event'}</span>
            
            <span class="absolute top-3 left-24 bg-purple-600/80 backdrop-blur border border-purple-400/30 text-white text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1 shadow-lg shadow-purple-500/20">
               <span class="w-1.5 h-1.5 rounded-full bg-pink-400 animate-pulse"></span> ${matchScore}% Match
            </span>

            <button onclick="toggleBookmark('${event.id}', this)" class="absolute top-3 right-3 p-2 rounded-full bg-black/30 backdrop-blur hover:bg-purple-600 transition group/heart">
              <i class="text-lg ${isBookmarked ? 'ph-fill text-red-500' : 'ph-bold text-white'} ph-heart transition-transform group-active/heart:scale-75"></i>
            </button>
          </div>
          <div class="p-5 flex-1 flex flex-col">
            <h3 class="text-xl font-bold mb-1 group-hover:text-purple-400 transition-colors">${event.title}</h3>
            <div class="flex items-center gap-4 text-sm text-gray-400 mb-4">
               <div class="flex items-center gap-1"><i class="ph-fill ph-calendar text-purple-500"></i> ${dateObj.toLocaleDateString()}</div>
               <div class="flex items-center gap-1"><i class="ph-fill ph-clock text-purple-500"></i> ${dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            </div>
            <div class="flex items-center gap-1 text-sm text-gray-300 mb-4">
               <i class="ph-fill ph-map-pin text-purple-500"></i> ${event.location || "TBA"}
            </div>
            <div id="timer-${event.id}" class="bg-white/5 rounded-lg p-2 text-center text-xs font-mono text-purple-300 mb-4 border border-white/5">Calculating...</div>
            <div class="mt-auto border-t border-white/10 pt-4">
              <details class="group/comments">
                <summary class="cursor-pointer text-xs font-bold text-gray-400 hover:text-white flex items-center justify-between select-none">
                  <span><i class="ph-bold ph-chats mr-1"></i> Reviews & Highlights</span>
                  <i class="ph-bold ph-caret-down group-open/comments:rotate-180 transition"></i>
                </summary>
                <div class="mt-3 space-y-2">
                  <div id="sentiment-summary-${event.id}" class="hidden mb-2"></div>
                  <div id="comments-box-${event.id}" class="max-h-32 overflow-y-auto pr-1 text-xs space-y-2 custom-scrollbar"><p class="text-gray-500 italic">Loading reviews...</p></div>
                  <div class="flex gap-2">
                    <input id="input-${event.id}" type="text" placeholder="Add a review..." class="flex-1 bg-white/5 border border-white/10 rounded px-2 py-1 text-xs focus:border-purple-500 outline-none text-white">
                    <button onclick="postComment('${event.id}')" class="bg-purple-600 text-white p-1 rounded hover:bg-purple-500"><i class="ph-bold ph-paper-plane-right"></i></button>
                  </div>
                </div>
              </details>
            </div>
            <div class="mt-4 pt-4 border-t border-white/5">
                <div id="btn-area-${event.id}">
                  <button onclick="registerEvent('${event.id}')" class="w-full py-2 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold shadow-lg shadow-purple-900/40 transition">Register Now</button>
                </div>
                <div id="qr-${event.id}" class="hidden mt-3 flex justify-center bg-white p-2 rounded-lg"></div>
            </div>
          </div>
        `;
        container.appendChild(card);
        startCountdown(event.id, dateObj);
        loadComments(event.id);
        checkRegistration(event.id);
      });
    }

    // --- UTILITIES ---
    function startCountdown(id, targetDate) {
      const el = document.getElementById(`timer-${id}`);
      const update = () => {
        const now = new Date();
        const diff = targetDate - now;
        if (diff < 0) { el.innerHTML = "<span class='text-gray-400'>Event Ended</span>"; return; }
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        el.innerText = `â³ Starts in: ${d}d ${h}h`;
      };
      update(); setInterval(update, 60000);
    }

    function analyzeSentiment(comments) {
        if (!comments || comments.length === 0) return null;
        const positiveWords = ['good', 'great', 'love', 'amazing', 'excited', 'awesome', 'best', 'cool', 'nice', 'fun', 'happy'];
        const negativeWords = ['bad', 'poor', 'boring', 'worst', 'hate', 'sad', 'angry', 'slow', 'waste', 'noisy', 'expensive'];
        const hypeWords = ['cant wait', 'hyped', 'fire', 'lit', 'lets go', 'ready'];
        let score = 0, hypeScore = 0;
        comments.forEach(c => {
            const text = c.text.toLowerCase();
            positiveWords.forEach(w => { if(text.includes(w)) score++; });
            negativeWords.forEach(w => { if(text.includes(w)) score--; });
            hypeWords.forEach(w => { if(text.includes(w)) hypeScore++; });
        });
        if (hypeScore > 2) return { text: "ðŸ”¥ High Hype Alert", color: "text-orange-400", border: "border-orange-500/50", bg: "bg-orange-500/10" };
        if (score > 2) return { text: "ðŸ˜Š Mostly Positive Vibes", color: "text-green-400", border: "border-green-500/50", bg: "bg-green-500/10" };
        if (score < -1) return { text: "âš ï¸ Mixed Reviews", color: "text-red-400", border: "border-red-500/50", bg: "bg-red-500/10" };
        return { text: "ðŸ’¬ Community Balanced", color: "text-blue-300", border: "border-blue-500/50", bg: "bg-blue-500/10" };
    }

    async function loadComments(eventId) {
      const box = document.getElementById(`comments-box-${eventId}`);
      const summaryBox = document.getElementById(`sentiment-summary-${eventId}`);
      const snap = await db.collection("events").doc(eventId).collection("comments").orderBy("createdAt", "desc").limit(10).get();
      if (snap.empty) { 
          box.innerHTML = `<p class="text-gray-500 italic">No reviews yet.</p>`; 
          summaryBox.classList.add('hidden');
      } else {
        box.innerHTML = "";
        const commentsData = [];
        snap.forEach(doc => {
          const c = doc.data();
          commentsData.push(c);
          box.innerHTML += `<div class="bg-white/5 p-2 rounded border-l-2 border-purple-500"><span class="text-[10px] text-purple-400 font-bold block">${c.userEmail.split('@')[0]}</span><span class="text-gray-300">${c.text}</span></div>`;
        });
        const sentiment = analyzeSentiment(commentsData);
        if (sentiment) {
            summaryBox.className = `flex items-center gap-2 p-2 rounded-lg text-xs font-bold border ${sentiment.border} ${sentiment.bg} ${sentiment.color} sentiment-badge`;
            summaryBox.innerHTML = `${sentiment.text}`;
            summaryBox.classList.remove('hidden');
        }
      }
    }

    async function postComment(eventId) {
      const input = document.getElementById(`input-${eventId}`);
      const text = input.value.trim();
      if (!text) return;
      await db.collection("events").doc(eventId).collection("comments").add({
        text: text, userEmail: currentUser.email, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      input.value = ""; loadComments(eventId);
    }

    async function checkRegistration(eventId) {
        const doc = await db.collection("events").doc(eventId).collection("registrations").doc(currentUser.uid).get();
        if (doc.exists) {
            document.getElementById(`btn-area-${eventId}`).innerHTML = `
                <button class="w-full py-2 rounded-xl bg-green-600/20 border border-green-500 text-green-400 font-bold cursor-default">Registered</button>
                <button onclick="cancelReg('${eventId}')" class="w-full mt-2 py-1 text-xs text-red-400 hover:text-red-300 underline">Cancel</button>`;
            const qrBox = document.getElementById(`qr-${eventId}`);
            qrBox.innerHTML = ""; qrBox.classList.remove("hidden");
            new QRCode(qrBox, { text: `TICKET:${eventId}:${currentUser.uid}`, width: 100, height: 100 });
        }
    }

    async function registerEvent(eventId) {
        if(!confirm("Confirm registration?")) return;
        await db.collection("events").doc(eventId).collection("registrations").doc(currentUser.uid).set({ email: currentUser.email, ts: firebase.firestore.FieldValue.serverTimestamp() });
        checkRegistration(eventId);
    }

    async function cancelReg(eventId) {
        if(!confirm("Cancel ticket?")) return;
        await db.collection("events").doc(eventId).collection("registrations").doc(currentUser.uid).delete();
        document.getElementById(`qr-${eventId}`).classList.add("hidden");
        document.getElementById(`btn-area-${eventId}`).innerHTML = `<button onclick="registerEvent('${eventId}')" class="w-full py-2 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold shadow-lg shadow-purple-900/40 transition">Register Now</button>`;
    }

    function isBookmarkedLocal(id) { return JSON.parse(localStorage.getItem('bookmarks') || '[]').includes(id); }
    
    function toggleBookmark(id, btn) {
        let saved = JSON.parse(localStorage.getItem('bookmarks') || '[]');
        const icon = btn.querySelector('i');
        
        if (saved.includes(id)) { 
            // Remove
            saved = saved.filter(x => x !== id); 
            icon.classList.replace('ph-fill', 'ph-bold'); 
            icon.classList.remove('text-red-500'); 
            icon.classList.add('text-white'); 
            
            // If currently on "Favorites" tab, refresh list instantly
            if(currentCategory === 'Favorites') {
                filterEvents('Favorites', document.querySelector('.active-filter'));
                return; // Stop here to avoid re-saving needlessly before refresh
            }
        } else { 
            // Add
            saved.push(id); 
            icon.classList.replace('ph-bold', 'ph-fill'); 
            icon.classList.remove('text-white'); 
            icon.classList.add('text-red-500'); 
        }
        localStorage.setItem('bookmarks', JSON.stringify(saved));
    }

    // --- MODIFIED FILTER FUNCTION ---
    function filterEvents(category, btn) {
      currentCategory = category;
      document.querySelectorAll('.filter-btn').forEach(b => {
          b.classList.remove('active-filter', 'bg-purple-600', 'text-white', 'border-purple-600');
          b.classList.add('border-white/10');
      });
      
      // Add active style
      btn.classList.add('active-filter');
      btn.classList.remove('border-white/10');

      if (category === 'All') { 
          renderEvents(allEvents); 
      } else if (category === 'Favorites') {
          // Filter by LocalStorage IDs
          const savedIds = JSON.parse(localStorage.getItem('bookmarks') || '[]');
          const favEvents = allEvents.filter(ev => savedIds.includes(ev.id));
          renderEvents(favEvents);
      } else { 
          renderEvents(allEvents.filter(ev => (ev.category || "").toLowerCase() === category.toLowerCase())); 
      }
    }

    function renderCalendar(events) {
        const calContainer = document.getElementById('calendar'); calContainer.innerHTML = "";
        const groups = {};
        events.forEach(e => { const dStr = parseEventDate(e).toDateString(); if(!groups[dStr]) groups[dStr] = []; groups[dStr].push(e); });
        Object.keys(groups).forEach(date => {
            let html = `<div class="glass-card p-4 rounded-xl"><h4 class="font-bold text-purple-400 border-b border-white/10 pb-2 mb-2">${date}</h4><ul class="space-y-2">`;
            groups[date].forEach(ev => { html += `<li class="text-sm flex justify-between"><span>${ev.title}</span><span class="text-xs bg-white/10 px-2 py-0.5 rounded">${ev.time || 'All Day'}</span></li>`; });
            html += `</ul></div>`; calContainer.innerHTML += html;
        });
    }

    document.getElementById('viewToggleBtn').addEventListener('click', () => { document.getElementById('event-list').classList.toggle('hidden'); document.getElementById('calendar').classList.toggle('hidden'); });
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        renderEvents(allEvents.filter(ev => ev.title.toLowerCase().includes(term)));
    });
  </script>
</body>
</html>
